#:::::::::::::::::::::::::::::::::::::::---:::--------:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::........................................
#:::::::::::::::::::::-:-----:::----------------------------------:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::......................................
#::::::::-----------------------------------------------------------------------::--::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::...........................
#::::------------------------------------------------------------------------------------------:--:::::::::::::::::::::::::::::::::::::::::::::::::::::....................
#:----------------------------------------------------------------------------------------------.:------:::::::::::::::::::::::::::::::::::::::::::::::::...::.............
#------------================================================----------------------------------=-..::::----------::::::::::::::::::::::::::::::::::::::::::::::::..........
#------===============================================================-------------------------:-:......::-----------------:::::::::::::::::::::::::::::::::::::::::.......
#--==================================++++===++++==============================-----------------:-....... ...:::----------------::::::::::::::::::::::::::::::::::::::::....
#=================+++++++++++++++++++++++++++++++++=============--===================--------=-:-:-==--::......:==--------------------::::::::::::::::::::::::::::::::::::.
#========+++++++++++++++++++++****++****++++++++++++=============================-----========:..::---===---:::..==----------------------::::::::::::::::::::::::::::::::::
#==++++++++++++++++++++++++***#*****+++++++++++++++++++++====+=-:::-------=--===--::-------==-:.     .========---==--------------------------::::::::::::::::::::::::::::::
#+++++++++++++++++++++*****####******++++++++++**++++++++++++++-.:.:-::--==========:.::::::--::--.:-:-=========--=====--------------------------:::::::::::::::::::::::::::
#+++++++++**************#######********++*++++++**++++++++++++=:....:-::-==========-:.....:-:-:::::-=============-=========-------------------------:::::::::::::::::::::::
#++***************###############**********++++++*++++++++++++-..  .:==-============-......:::-:::...::-:-=====================------------------------::::::::::::::::::::
#******************##############********************++++=--===:-==++++++++++++===+=-.......::::.:.::.::.::.:----=================------------------------:::::::::::::::::
#******************####%%%#########*******************++++*=:::::--===+++++++++++++=:...... .:......:.:..:.....:======================------------------------:::::::::::::
#*****##################%%%%%########*********************+=-:::::::.-=++++++++++++-. ..... .:......:.::.::.....-++======================-----------------------:::::::::::
##########################%%%%%###########*****************-....... .:*+++++++++++-.....    ...........:..:. ... :++++++=====================--------------------------::::
#########################%%%%%%%%%%%%#######**************+===:...::..+*+++++++*+:      .................... .....-++++++===+====================------------------------::
##############################%%%%%%%###########**#*===++++***=.::=*++++***++++-..:--==++=++==-:. . .... ... ......=+++++++==+++====================-----------------------
##################################%%%%%%%%###########+::::----=:==+*********=-::-==++++*++*++=:..     :==-:.   ... :*++++++++=++++++====================---------======----
#######%%%%%%%%%%%%%%%##%%####%%%##%%%%%%%%%#########*=:...--::::::-:--==++***+:::::---:-===+-.... .: .++**+=-.  ...+*++++++++==+++++++=====================--==+++====----
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%##%%%#######*=:....::::::::.::.:-+=+*+::....::.:-::-:..::.-++++*+*****+-.  +**+++++++++=+++++++++===================+++++===------
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%####%#######*=......:...:.:.::..:***+*+=-:......:--:--:.::...::===+++**#*=:=****+++*++++++++++++++++=============++*+++++==-------
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%######+:..........:.:..:.. -****#+--.......:::.--:.::::..::-::-==-+*+++++***++**+++++++++++++++++========+***++++===--------
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%#####%+.  ..............:....****#*--:.......:::..::.:.::.::::::.::-:--=*+++**++***+*++++++++++++++++++++++***+++======------
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%######%%%+--=++*+=::.....::.  .. =***##=::........::..::.::.:..::.::.....-****+++***++****++++++++++++++++++++++*+++++++======---
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%#====**####*+-..   .#**=:  .:#**##-::........:....:..:.:..::..::.... :*****++***++*****+++*++++++++++++++++++++++++++=======
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*---=--=--=--:.===###%%*- .##*#*::. ..... .........:..........:.... :*****=+****++*****++**++++++++++++++++++=============
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=:.:::-:::..--:-====*##%*-+#*#=:: ...... .......................... -*****--****+++****+++**++++++++++++++++=============
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+-.....:-::::::::::.:::--=:=*=:..         ..  ................. .....+*****-:+****+++****++****+++++++++++++++++=========
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#+-......::.::.:.:.:::... .---.    ..::---==-::..  ......   .... .... -#****#-:=*****+++***++*****+++++++++++++++++++=====
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-......::..:.::::.::.....:: .-=+**###**##*+-:..    ..+===-:.   ......+#*+***=:-=+****+++***++******++++++++++++++++++===
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=-.......::.:.:..:.:.......:-=======++=*#+*-::... ..  =**#%#+=:    ....=#*++**+-::=*****+++***+*******+++++++++++++**++++
#%%@@@@@@@%%%%%%@%%%@%%%%%%%%%%%%%%%%%%%%%%%%%%%%+-.......::..:.:.......   .--...:::.:..-::--...::: -*++*#**###*#=.::. ..::*#*+**+-:::+#****+++**++*********+++++++****+===
#@@@@@@@@@@@@%%%%@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%#-. .    ............... .. .=-:........:-::--.:.:-.:---=++*+*##*##-:=-. ::.+#*++++=-::=*******+++++**********+++*****+====
#@@@@@@@@@@@@@@@%@@@@@%@%%%%%%%%%%%%%%%%%%%%%%%*:...::-----:...........  ... :==:........:=-:=-:::::::..:::.:-====++-.-*=::..+#***+==-:.:+#******+++++****************+====
#@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%##%*==*#%%%%##%*=-:.    :*+=:.    .=--.........:-:.=-::.::.:::.:::..:.:.=%*..+#=:..+#**++==--::-*#******+++=+********++++++====-
#@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%++==+++*++*+*##+-:.:..:::#%%#%*-.  =--:.........::::-::..:..:::..::. . .-*%#: :=-:..*#*===--:::.:=*#*******+===+***=--+*++++====
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%%%%%%%%%%%%%@+=----:::-::::::::::==+*#+#%%%#+::---..........::.::::.::..:....::.... .+%#- .-:..:*#*--::::....:=*#*******=..+-:-+*****++++++
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%*=-:......:--=-:::::::.:-:-====+===--........ .::..:.:..:..:....:::. ... +%#= :-:..:*#+::........ :+##******-. :+#*******+++++
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%*=:=.:.......:::::::::::::::.....:---........ ................. ..:. ... .##%+.-:....+#*..          :=*#*+:..-=************+++
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%*-.=:.........:::..:....:.::..... ---........ ......................  ... =%#%+::.... =* .:-==++++++=--=:.-+++**************++
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@%=::-=..........:::..........:.....--: ......  ............ ..........  ....*%##:.......::*#########*+-..=#*+*#***************+
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@*:...=:.........:::......:..... . :-: ..       ........ ..     . ..... . .. .*%*.........+***#####+-::--.++=*#*****************
#@@@@@%%%%@%%%%%%%@@@@@@%%%@@@@@@@@@@%@@@@@*--=+++:........ .:.............  .-:  ....:-++++++-...   .:=+-=::...    .... .+.      .. :#*+***=::-++=::=+*#******************
#@@@@%%%%%%%%%%%%%@@%%%%%%%%%%%%%%%%%%%@%%#+*****+:........ ........... ... .:. .....:::=+**#=-::.   .=+%**%#***=-:   .....+++==-:.  .*##+:..-*+++*#*+*#####***************
#@@@@@@@%%%%@@@@@@@@@@%%%%%%%%%%%@@@@@@@%##+++++==......... ............: ..:.......... ..:*===-=-..::=++%+#%**#%%#+=. ....*%%%%###+.:*=:.-----***#*+###########*********++
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*-:::=-.......  .............  ..........--:.:.-==+-+*=::--=***%+##**#%###*- .. +%####%%#=:::===--+#**#**####***+++*************
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=-:::...::::.::::...   .-:..............-%%%*#*=+==**=::=-=+***++%#**#%##*#:  -###%*++-.:=**=..*#%****#%##***++++**************
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+---:.:::-:-:.:-::.:. .:.==::.......  ....=%###=++=+#*-::+-=++*=+**%***###%+.:+%%%#+:..-*#+-.::.##****################**********
#%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%=:--:::.:..::..::..:..:::--::.....:#*=-:...+#%++*++#**-:.+===+**=**#%*#*%%#*#%%#+-:-::#%*-.:--::#***###################*********
#####%%%%%@@@@@@@@@%%@@@@@@@@@@@@@@@@@%%@@#:::.....-:..::--...-:.--+=*#*-....:@@@@%*+--%++**+##**=:.+===:*%=-#+**=+=#%%#+-:-++=:--:.==---::+*####################**********
#%%%%%%%%%%%@@@@@@%%%%%@@%%%%@@@@@@@@@@#%@=-===+*=--:-+#%#*::=*-:+=+++#@**=: .=+*#%@@%%*+++++%##*--.==--.:--.::.:-. =+-::=***=:-:-:++:----+#####################***++++==++
#%%%%%%%%%%%@@@@@%%%%%%%%%%%%%@@%%%@@@@@##%@@@@@#+--.:==**:-***::+=+*+*%%#@#+=:..:+**#*+++++#%#+=-:.:=-.....:......... .:::-:..:-=-:.-#**#%################****#*****+=====
#%%%%%%%%@@@@@@%%%@%%%%%%%%%%%@@%%%%@@%****+#*+=---:....:::#%##-:+=+**=#%###%@%#++=-+==++==+###+=-:.:=....................::....+***####%%################**********++++===
#@@@@@%%%%@@%%%%@@@@@%%%%%%%%@@@@@@@@@@%@%%%===:-:--:::::::-=+#--*++**++%@*%@%%@@%#===------::-:-:.:::.::............. .:....::*@%%%###%%#####################***+++++++++=
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%@@#%%%+==:-=--:.::.:..-:=-:+=--:-:=+%*@#*++*=----:-:.....:::::....:.............::......*%#####%%%%%#####******##########******++*+++
#@@@@@@@@@@@@@@@@@@@@@@@@%%%%%@@@@@%%@@%**++=:-::-::::-:::::::=-..:......:#+==--:-----:::. ..::::::::::......................+####%%%%%%###***##******##############*******
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#--+--===+:.......-:.:.:..:::.-+::----::-:  ...::::::::::...........:::.........=++%%%%%%%%####**##***##########**************+
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+-=-====+:...:.:.-:.:....:::-----:-:::-: .::::::::::.............. :::  ..:....++*%%%%%%%%%#####%%%%%%%#############**********
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%##++=+==++++:.:.:...::.::....:.----=---=:. .:-::-:::..:.......:::.... ......::.:..+@%%%%%%%%%%%%%%%%%%%%%%##################*****
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*-==-===--=:......:-:.:::.:::--=----:-- .:::::...::..::......:.:.... ....:.:..::.:=%%%%%%%%%%%%%%%%%%%%%%%%%####################
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*---====-:=:-:....**=:..:::::----.:--=- ::--::.:.::...::........ ....::.:::::...:-=%%%%%%%%%%%%%%%%%%%%%%%%%%%%%################
#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*-::-++++==:::-::::::...:::----------:..:--:::....-............... :::..:::::::.-@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%########
#@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%#--==+++==---+===--------------::::.::---:::::.::................ :.:::::..:.:.:########################***********************
#%%%%%%%%%%%%%%%%%%%%########################+==++========------:==:==--===-==--===--:::::.:................   ....::....::=******+++++++++++++++++++++++++++==============
##%%%%#%%%%###################################+=++===++++========+-:=+=====----==---::.....::...........         ........+++++++++++++++++++++++=========================--
#####*****************#************************+++=+++++++==-++++=-::::-=--:-=====---:......: ..... ..... ..    .:..... -+=======-=====================-=====--------------
#**+++++++++++******************************+++=-=-==-=-=+++=+=+==----========---::::::..............           ::.... -===========-----==-------------:-------------------
#*+++++++***++++++****+++===+====----------===-:-=++++++++++++++=-----=====------::::.......... .              .:..   -========-------------------------::::::------:::::::
#-===+++******++++=---:::::::::::::::::::::--:::---===++*****#**+==----=-=-:--::::..::...                    ..:.. ...:::::::::::---------------::-----:::::::::::::.......
#+++====---------===++++===========-----====-::::::::::::::-----::---=++======---==++*+=-:::::......:--:---==+++++=--:::::.................::::----------:::::.............
#:::::::---==++****+==---:::-----=========--::::::::::::::::::::::...:::::..::::---:::::::::::::------::::::::----::..:::::::::::::::::::::::::::::::::::::::::::::::::::::
#=====++*****+=-::.................:::------:::.......................:::............ .        ...:::..  .    ....   ...............:::::::...........      ...............                                                                                                                                     ............ 
#...........................................:*+............................................................................................................................
#.............................................==...........................................................................................................................
#............................................ .+...........................................................................................................................
#...........................................:=#=...........................................................................................................................
#....................................:=*#%%%@@+............................................................................................................................
#...................................*@@@@@@%+:.............................................................................................................................
#.................................:#@@@@@#:................................................................................................................................
#.................................#@@@@%%#:................................................................................................................................
#.....=#**+==-::.................=@#=::....................................................................................................................................
#.... .%@@@@@@@@%#*+=-:..........#=..........................==............................................................................................................
#...:=*%@@@@@@@@@@@@@@@%##+=-::.:+ ............... :=....:=*%@*............................................................................................................
#.-%@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#*+==--::......::+*:-+*%@@@@@*............................................................................................................
#+%*=-===+*#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%@%:.#@@@@@@@@*............................................................................................................
#*. .........::-=*%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@*...=@@@@@@@@*....=-......................-=:.................:=.................-...........-:.................:=........
#*:.......... .:--:..:-=+*#%%%@@@@@@@@@@@@@@@@@%=....:@@@@@@@@*...+@@#-..................=#@@%+:.............-*@@*.............-*%%........:=#@-...............-*@@+.......
#:*=.........=+=:......    .:+%@**+**###%%%%%#+.......%@@@@@@@* .#@@@@@#=............:=#%@@@@@@@*:.......:-+%@@@@@#:.....::-+#%@@@#...:-=*%@@@@-...........:-*%@@@@@#: ....
#..:.......=%*:........:-=+#@@@%=- ...................#@@@@@@@*:%@@@@@@@@%+:....:-=*#@@%@@@@@@@@@+..:-=+#%@@@@@@@@@@+:.:=*@@@@@@@@#..:%@@@@@@@@-......:-=+#@@@@@@@@@@@+:.:=
#........-#@*.........:%@@@@@@@%=-....................*@@@@@@@#==#@@@@@@@@@#..+%@@@@@@@::*@@@@@@%.-%@@@@@@@+#@@@@@@@@@%+::@@@@@@@@#...#@@@@@@@@-....=%@@@@@@@=#@@@@@@@@@#+:
#.......+@@%...........*@@@@@@@%=-....................*@@@@@@@* ..-%@@@@@@@=..-@@@@@@@@-..:+@@@@-.:%@@@@@@@=.#@@@@@@@@*...#@@@@@@@#...=@@@@@@@@-....:@@@@@@@@-.#@@@@@@@@+..
#.....:#@@@*...........-@@@@@@@%=-....................+@@@@@@@*....%@@@@@@@:..:%@@@@@@@-...:@@@=...*@@@@@@@+ .=%@@@@@=....*@@@@@@@#...-@@@@@@@@-.....#@@@@@@@= .+%@@@@@- ..
#....:%@@@@#...........:@@@@@@@%=-....................+@@@@@@@*...:%@@@@@@@:...%@@@@@@@-...+@@=....*@@@@@@@*....-+##-.....=@@@@@@@#...:%@@@@@@@-.....#@@@@@@@+ ...=*##-....
#...:%@@@@@#...........:@@@@@@@%=-....................+@@@@@@@*...:%@@@@@@%:...%@@@@@@@-..:@%-.....*@@@@@@@@*:............=@@@@@@@#....%@@@@@@@-.....#@@@@@@@@+:...........
#...+@@@@@@@:..........-@@@@@@@%=-....................+@@@@@@@*...:%@@@@@@%:...#@@@@@@@- :##:......-@@@@@@@@@@*=:.........=@@@@@@@#....%@@@@@@@-.....=@@@@@@@@@%*-:........
#...*@@@@@@@=..........=@@@@@@@+--....................+@@@@@@@*...:%@@@@@@%:...%@@@@@@@-:+=.........=@@@@@@@@@@@%#=:......=@@@@@@@#....%@@@@@@@-......=@@@@@@@@@@@%*=......
#...*@@@@@@@#..........*@@@@@@= =-....................+@@@@@@@*...:%@@@@@@@:..:%@@@@@@@++----:.......:+%@@@@@@@@@@@@*:....-@@@@@@@#....%@@@@@@@-.......:*%@@@@@@@@@@@%+:...
#...=@@@@@@@@+........:@@@@@*:..=-....................+@@@@@@@*...:%@@@@@@@:..:%@@@@@@@-................=*%@@@@@@@@@@@=...-@@@@@@@#....#@@@@@@@-.........:=*%@@@@@@@@@@@=..
#...:%@@@@@@@@-......:%@@%+:... == ...................+@@@@@@@*...:%@@@@@@@-..:%@@@@@@@-................  :+*@@@@@@@@@@=..-@@@@@@@#....#@@@@@@@-..........  -+#@@@@@@@@@@-.
#....=@@@@@@@@@-....=%%*-......+%%=...................+@@@@@@@#....%@@@@@@@-..:%@@@@@@@-................-*@= :*@@@@@@@@#..-@@@@@@@#....#@@@@@@@-..........-*@- -#@@@@@@@@*.
#.....*@@@@@@@@@=.-++-.......=%@@@@%=.................+@@@@@@@#....#@@@@@@@+..:%@@@@@@@=...........:-=*%@@@+...+@@@@@@@#..-@@@@@@@%....#@@@@@@@=.....:-=*%@@@=...*@@@@@@@#.
#......#@@@@@@@@@#-. ........=%@@@@#-.................+@@@@@@@%....*@@@@@@@*..:%@@@@@@@=..........-@@@@@@@@*....%@@@@@@%:.-@@@@@@@%....#@@@@@@@=....=@@@@@@@@+...:@@@@@@@#.
#.......*@@@@@@@@@@+:..........=%%=...................*@@@@@@@@:...+@@@@@@@%..:@@@@@@@@*...........#@@@@@@@#....#@@@@@@@= =@@@@@@@%:...%@@@@@@@+.....%@@@@@@@*....%@@@@@@@-
#........=@@@@@@@@@@@*-........ =- ...................*@@@@@@@@=...=@@@@@@@@-.:@@@@@@@@%:.......:..-@@@@@@@@:...#@@@@@@@+ =@@@@@@@@-..:%@@@@@@@#...-.=@@@@@@@%:...%@@@@@@%=
#.........:#@@@@@@@@@@@%*=:.....==.:.......:....-=:...#@@@@@@@@#...:@@@@@@@@+ -@@@@@@@@@*......=-...%@@@@@@@+...#@@@@%+:..+@@@@@@@@#.-=%@@@@@@@@-.=-.:%@@@@@@@+...%@@@@%+..
#...........-#@@@@@@@@@@@@@#*=-:=- ..........:-=-:....#@@@@@@@@@*...#@@@@@@@%.-@@@@@@@@@@%+---+-....+@@@@@@@@- .#@@@+:....+@@@@@@@@@#-:%@@@@@@@@@+:...*@@@@@@@@- .#@@@+....
#.............-*%@@@@@@@@@@@@@@@@%**++====+*#*=:.....:@@@@@@@@@#:...+@@@@@@@@:=@@@@@@@@@@@@@@#:.....:%@@@@@@@@=.#@*:......#@@@@@@@@%- -@@@@@@@@@+.....:@@@@@@@@%=:%@+:.....
#...............:=*@@@@@@@@@@@@@@@@@@@@@@@@*-........-#+:+@@@@*.....:@@@@@@@@:+#-:+@@@@@@@@@+........=@@@@@@@@@#+-........#+:=@@@@#:..=#-:#@@@@=.......=@@@@@@@@@#+:.......
#..................:=*#@@@@@@@@@@@@@@@@%+-................=%@+.......*@@@@@@=......:=*%@@@#-..........-#@@@@%*=:..............-#@*.........+%%-.........=%@@@%%*=:.........
#......................:-+*#%@@@@@%#*=-....:................:........-@@@@@=...........:::..............::::....................:.........................::::.............
#............................:::+=....................................%@@#-................................................................................................
#...............................+:...................................:%#-..................................................................................................
#.............................-#=...............................:===--:....................................................................................................
#.................................................-#+......................................................................................................................
#...................................................+=.....................................................................................................................
#....................................................*.....................................................................................................................
#...................................................*+.....................................................................................................................
#...........................................:==+++#@#......................................................................................................................
#........................................:+%@@@@@@%=.......................................................................................................................
#.......................................+@@@@@%#*-.........................................................................................................................
#......................................+@@@@@@@: ..........................................................................................................................
#.....................................=@@@@%%##+...........................................................................................................................
#................... .................%@*-::. .............................................................................................................................
#..........:==---=+**+=-:............-%:... -+:...........-+:..............................................................................................................
#......:=*%@*:....:-*@@@@%*=:........+= ...=@@@*:........=@@@*:............................................................................................................
#....-*%@@@+ ....... :*@@@@@@#-......+:...+@@@@@@*-.....+@@@@@@*-..........................................................................................................
#..-#@@@@@#............+@@@@@@@#:....+:.:#@@@@@@@@@#-.:#@@@@@@@@@#-........................................................................................................
#.*@@@@@@@+.............*@@@@@@@@-...+.:+#@@@@@@@@@@@#+#@@@@@@@@@@@#:......................................................................................................
##@@@@@@@@+..............%@@@@@@@@-.:=-=..-*@@@@@@@@@#..-*@@@@@@@@@#................=#+:.........................:+#=.............:+-....+#-....................=#+:.......
#@@@@@@@@@#..............=@@@@@@@@%:.*=.... +@@@@@@@@=... +@@@@@@@@=.............:+%@@@@*:.....................-*@@@@%+:.......:=#@@=...*@@@#-...............:+%@@@@*-.....
#%@@@@@@@@@=.............:%@@@@@@@@+.+......*@@@@@@@@-....*@@@@@@@@-..........-+%@@@@@@@@@*-...............:=*%@@@@@@@@%+::-=*#@@@@@= :#@@@@@@#=..........-+#@@@@@@@@@#-. .
#+@@@@@@@@@@-.............#@@@@@@@@%:+......#@@@@@@@@-....#@@@@@@@@-....::-+#%@@%@@@@@@@@@@@#-........:-=+#@@%%@@@@@@@@@@-%@@@@@@@@@=:%@@@@@@@@@*....:-+*%@@%@@@@@@@@@@@#-.
#.*@@@@@@@@@@=............+@@@@@@@@@-=......#@@@@@@@@-....#@@@@@@@@-..+%%@@@@@@%:-#@@@@@@@@@@@+....:#%%@@@@@@*.=%@@@@@@@#.*@@@@@@@@@*=+%@@@@@@@@+.+%%@@@@@@%:-#@@@@@@@@@@@%
#..*@@@@@@@@@@+...........+@@@@@@@@@==......#@@@@@@@@-....#@@@@@@@@-..+@@@@@@@@%:..-*@@@@@@@@@-.....#@@@@@@@@*...=#@@@@@- -@@@@@@@@@+...+@@@@@@#..=@@@@@@@@@:..-*@@@@@@@@@*
#...*@@@@@@@@@@#:.........+@@@@@@@@@==......#@@@@@@@@-....#@@@@@@@@-..-@@@@@@@@%:....%@@@@@@@%:.....=@@@@@@@@*... :@@@@+..:%@@@@@@@@=... +@@@@#:..:%@@@@@@@@:....%@@@@@@@%=
#....=@@@@@@@@@@%:........+@@@@@@@@@-=......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...:@@@@@@@@#......=@@@@@@@@*....-@@@+....#@@@@@@@@=....*@@@=....:%@@@@@@@@:...:%@@@@@@@#.
#.....-%@@@@@@@@@%:.......+@@@@@@@@#:+......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......-@@@@@@@@*....-@@-.....*@@@@@@@@=...:@@+:......%@@@@@@@@:...:@@@@@@@@#.
#......:#@@@@@@@@@#.......+@@@@@@@@=.+..:=--%@@@@@@@@+-=:.#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......-@@@@@@@@*....=%:......*@@@@@@@@=...*%:........%@@@@@@@@:...-@@@@@@@@#.
#........+@@@@@@@@@+......*@@@@@@@#.:+......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......-@@@@@@@@*....+= ......*@@@@@@@@=...*:.........%@@@@@@@@:...-@@@@@@@@#.
#.........+@@@@@@@@%:.....*@@@@@@%:.:+......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......-@@@@@@@@*....-+.......*@@@@@@@@=...=-.........%@@@@@@@@:...-@@@@@@@@#.
#..........*@@@@@@@@=.....#@@@@@@-..:+......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......=@@@@@@@@*.....=*-.....*@@@@@@@@=....+*:.......%@@@@@@@@:...-@@@@@@@@#.
#..........:@@@%-=+#=....:@@@@@@-...:+......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......=@@@@@@@@*......--.....+@@@@@@@@=.....-:.......%@@@@@@@@:...-@@@@@@@@#.
#..........:@@%:.........=@@@@%:.....=......#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......=@@@@@@@@*.............+@@@@@@@@=..............%@@@@@@@@:...-@@@@@@@@#.
#..*+:....-%@+:..........#@@@*:.....+%-.....#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......=@@@@@@@@*.............+@@@@@@@@=..............%@@@@@@@@:...:@@@@@@@@#.
#..:===--=+=:...........+@@@=.....=%@@@#-...#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@%:...-@@@@@@@@#......=@@@@@@@@#.............+@@@@@@@@=..............%@@@@@@@@-...:@@@@@@@@#.
#......................=@@*:.....*@@@@@@@=..#@@@@@@@@-....#@@@@@@@@-..:%@@@@@@@@:...-@@@@@@@@#......=@@@@@@@@%.............+@@@@@@@@+.............:%@@@@@@@@-...:%@@@@@@@#.
#....................:*@*-.......:+%@@@%=:..#@@@@@@@@-....#@@@@@@@@=..:%@@@@@@@@-...-@@@@@@@@%:.....=@@@@@@@@%:............*@@@@@@@@+.............:%@@@@@@@@=....%@@@@@@@%=
#.................:-+#+:...........:*%+.....#@@@@@@@@-....#@@@@@@@@+..:%@@@@@@@@=...-@@@@@@@@@:.....+@@@@@@@@@-............*@@@@@@@@*.............:%@@@@@@@@*....#@@@@@@@@#
#..............:-=++-:............:..+......#@@@@@@@@-....#@@@@@@@@#..:%@@@@@@@@+...+@@@@@@@@@=...-.+@@@@@@@@@*........::..*@@@@@@@@%...::........:@@@@@@@@@%....+@@@@@@@%#
#.........-==--==:.  .....:.......:.:*......#@@@@@@@@-...:%@@@@@@@@@- -@@@@@@@@@%:.=*@@@@@@@@@#.:+- *@@@@@@@@@@- .....-+:..#@@@@@@@@@= -+:........-@@@@@@@@@@=...=@@@@@%+..
#.........-@@@@@@%%#*=-:............+*......#@@@@@@@#....:@@@@@@@@@@@=-@@@@@@@@@@%+:+@@@@@@@@@@#+:..*@@@@@@@@@@@+-:..-=....%@@@@@@@@@@*=..........-@@@@@@@@@@%:..-@@@@+:...
#..........#@@@@@@@@@@@@%#+=-::::-=##+......#@@@@@@@-....-@@@@@@@@@@%-=@@@@@@@@@@#: *@@@@@@@@@@*....#@@@@@@@@@@@@@%%%=....:%@@@@@@@@@@=...........=@@@@@@@@@@@#: :@@*:.....
#......:+#@@@@@@@@@@@@@@@@@@@@@@@@@#:+......#@@@@@@=.....=@%+%@@@@@#: *@#+@@@@@@*...#@*+@@@@@@+....:@@*+@@@@@@@@@@@%-.....-@%+#@@@@@%-............*@#+%@@@@@@@@@*+#-.......
#....:#@@@@@@@@@@@@@@@@@@@@@@@@@@@*.:+.....:%@@@@@=......--. :#@@@*...=-. -%@@@+....=:..=@@@@=.....:=:..:+%@@@@@@@*:......-=. .*@@@#:.............--. -%@@@@@@@%*-.........
#...:%#+=----==+*#%@@@@@@@@@@@@@@+..:+.....:@@@@%-.............=#+.........:+#=..........:+#-..............-+*#%*-..............-**.....................+###*=-. ..........
#...+-.............:-=*#%@@@@@@#-...:+.....=@@@#:..........................................................................................................................
#...+=...................::--=-.....:+.....#@@+............................................................................................................................
#...:**-............................++....*@*:.............................................................................................................................
#.....==..........................-**:..-*#-...............................................................................................................................
#.................................-=..:=+-.................................................................................................................................


# -------------------------------
# PROBE OUT Macro
# -------------------------------
[gcode_macro PROBE_OUT]
description: Move the probe out to the specified position
gcode:
  G90                      ; Set to absolute positioning
  G1 X245 F4000             ; Move the probe to X245 at feedrate 4000
  G4 P300                   ; Wait for 300ms
  G1 Z15                    ; Move Z-axis to 15mm
  G1 X0                     ; Move X-axis back to 0

# -------------------------------
# PROBE IN Macro
# -------------------------------
[gcode_macro PROBE_IN]
description: Move the probe in to the starting position
gcode:
  G90                      ; Set to absolute positioning
  G1 Z20                    ; Move Z to 20mm
  G1 X245 F12000            ; Move X-axis to 245mm at feedrate 12000
  G1 Y0                     ; Move Y-axis to 0mm (check against stepper_y position_min)
  G1 Z0                     ; Move Z-axis down to 0
  G4 P300                   ; Wait for 300ms
  G1 X220 F6000             ; Move X-axis to 220mm at feedrate 6000
  G1 Z10                    ; Move Z to 10mm
  G1 X0                     ; Move X-axis back to 0

# -------------------------------
# Pause Macro
# -------------------------------
[gcode_macro PAUSE]
description: Pause print and park the head to back left to avoid picking up the klackprobe
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}             ; Get the extrusion amount
  {% set x_park = 5.0 %}                                               ; Set X parking position (left side)
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}        ; Set Y parking position (max Y - 5)
  {% set act_z = printer.toolhead.position.z|float %}                   ; Get current Z height
  {% set z_safe = act_z + 20.0 %}                                       ; Move Z up by 20mm

  PAUSE_BASE                 ; Call the existing pause macro
  G91                        ; Switch to relative positioning
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100           ; Retract the extruder by E amount at feedrate 2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}  ; If extruder is not ready, display a message
  {% endif %}

  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900         ; Move Z up by 20mm
    G90                        ; Switch back to absolute positioning
    G1 X{x_park} Y{y_park} F6000 ; Move to back-left (X=5, Y=max Y - 5)
  {% else %}
    {action_respond_info("Printer not homed")}  ; If printer is not homed, display a message
  {% endif %}

# -------------------------------
# Resume Macro
# -------------------------------
[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}             ; Get the extrusion amount from the pause
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY) %}              ; Get the velocity parameter if specified
  {% else %}
    {% set get_params = "" %}                                           ; Set default empty parameters if no velocity is provided
  {% endif %}

  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91                        ; Switch to relative positioning
    G1 E{E} F2100              ; Extrude the required amount at feedrate 2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}  ; If extruder is not ready, display a message
  {% endif %}

  RESUME_BASE {get_params}     ; Call the existing resume macro with velocity if defined

# -------------------------------
# Cancel Print Macro
# -------------------------------
[gcode_macro CANCEL_PRINT]
description: Cancel the current print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS            ; Turn off all heaters
  CANCEL_PRINT_BASE           ; Call the existing cancel print macro

# -------------------------------
# Preheat and Cool Load Macros
# -------------------------------
[gcode_macro PREHEAT_LOAD]
description: Preheat the printer to 240°C for filament loading
gcode:
  M104 S240                   ; Set extruder to 240°C

[gcode_macro COOL_LOAD]
description: Cool down the printer to 0°C after filament loading
gcode:
  M104 S0                     ; Set extruder to 0°C

# -------------------------------
# Filament Loading Macros
# -------------------------------
[gcode_macro LOAD_FILAMENT]
description: Load filament with extrusion
gcode:
  M117 Loading Filament...    ; Display loading message
  M83                        ; Set extruder to relative mode
  G1 E60 F1000               ; Extrude 60mm of filament at feedrate 1000
  G1 E100 F250               ; Extrude 100mm of filament at slower feedrate
  G92 E0.0                   ; Reset the extruder position to 0
  M400                       ; Wait for all moves to finish
  M117 Load Complete         ; Display completion message

[gcode_macro LOAD_FILAMENT_SLOW]
description: Load filament slowly to avoid extruder issues
gcode:
  M117 Loading Filament...    ; Display loading message
  M83                        ; Set extruder to relative mode
  G1 E50 F250                ; Extrude 50mm at feedrate 250
  G1 E50 F250                ; Extrude another 50mm at feedrate 250
  G1 E30 F100                ; Extrude 30mm at slower feedrate
  G1 E30 F100                ; Extrude another 30mm at slower feedrate
  G92 E0.0                   ; Reset the extruder position to 0
  M400                       ; Wait for all moves to finish
  M117 Load Complete         ; Display completion message

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament
gcode:
  M117 Unloading Filament...  ; Display unloading message
  M83                        ; Set extruder to relative mode
  G1 E0.5 F1000              ; Retract 0.5mm of filament
  G1 E-0.5 F1000             ; Unload 0.5mm of filament
  G1 E1.0 F1000              ; Load 1mm of filament
  G1 E-1.0 F1000             ; Unload 1mm of filament
  G1 E1.5 F1000              ; Load 1.5mm of filament
  G1 E-1.5 F1000             ; Unload 1.5mm of filament
  G1 E2.0 F1000              ; Load 2mm of filament
  G1 E-120 F1000             ; Unload 120mm of filament to fully clear the extruder
  M117 Remove Filament Now!  ; Display message to remove filament
  M400                       ; Wait for all moves to finish

[gcode_macro PURGE]
description: Purge filament to clear the extruder
gcode:
  M83                        ; Set extruder to relative mode
  G1 E50.0 F250              ; Extrude 50mm of filament at feedrate 250
  G90                        ; Switch to absolute positioning
  M400                       ; Wait for all moves to finish

# -------------------------------
# Filament Runout Detection Macros
# -------------------------------
[gcode_macro RUNOUT_ON]
description: Enable filament runout detection
gcode:
  SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=1

[gcode_macro RUNOUT_OFF]
description: Disable filament runout detection
gcode:
  SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=0

# -------------------------------
# Loading Position and Heating Macros
# -------------------------------
[gcode_macro HEAT_AND_MOVE_TO_LOAD]
description: Preheat the printer and move to the loading position
gcode:
  M104 S240                   ; Preheat extruder to 240°C
  {% if printer.homed_axes != 'XYZ' %}
      G28                      ; Home all axes if not already homed
  {% endif %}
  G1 X115 Y115 F10000         ; Move to filament loading position (X115 Y115)
  G1 Z40 F60000               ; Move Z to 40mm at a very fast rate
  M109 S240                   ; Wait for extruder to reach 240°C
  SET_PIN PIN=beeper VALUE=1   ; Activate beeper
  G4 P200                     ; Wait for 200ms
  SET_PIN PIN=beeper VALUE=0   ; Deactivate beeper

# -------------------------------
# Bed Mesh Calibration Macros
# -------------------------------
[gcode_macro G29]
description: Load the bed mesh profile
gcode:
  BED_MESH_PROFILE LOAD=thesus  ; Load the bed mesh profile 'thesus'

[gcode_macro COMMIT_BED_MESH]
description: Calibrate the bed mesh and save the profile
gcode:
  M140 S70                     ; Set bed temperature to 70°C
  {% if printer.homed_axes != 'XYZ' %}
      G28                        ; Home all axes if not already homed
  {% endif %}
  M190 S70                     ; Wait for bed to reach 70°C
  G4 S60                       ; Wait for 60 seconds
  BED_MESH_CALIBRATE           ; Perform bed mesh calibration
  BED_MESH_PROFILE SAVE=thesus  ; Save the bed mesh profile as 'thesus'
  SAVE_CONFIG                  ; Save the configuration


# -------------------------------
# Test Speed
# -------------------------------
[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

Here's the updated Clipper macro that repeats the thrusting pattern for 100 thrusts (50 full cycles):

[gcode_macro BED_THRUST_100]
description: "Moves bed with varying speeds in a thrusting pattern for 100 thrusts"
gcode:
    G28                          ; Home all axes
    G0 Z0                        ; Move bed to lowest position
    G0 Z40 F2000                 ; Retract 40mm at moderate speed
    {% for i in range(50) %}     ; Loop 50 full cycles (100 thrusts)
        G0 Z0 F5000              ; Fast thrust forward
        G0 Z40 F1500             ; Slow retract
        G0 Z0 F3000              ; Medium thrust forward
        G0 Z40 F4000             ; Fast retract
    {% endfor %}



    
    